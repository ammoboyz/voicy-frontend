<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Sound</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 16px;
      background: #ffffff;
      color: #111;
    }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 14px;
      max-width: 720px;
      background: #ffffff;
    }

    .row {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
    }

    label { font-size: 14px; color: #374151; }

    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
    }

    .muted { color: #6b7280; font-size: 13px; }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
    }

    .btn-primary {
      background: #111;
      color: #fff;
      border: none;
    }

    .btn-disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .tabs button {
      margin-right: 6px;
    }

    .tabs button.active {
      font-weight: 600;
      border-bottom: 2px solid #111;
    }

    .sound-item {
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    .sound-item audio {
      width: 100%;
      margin-top: 6px;
    }

    audio {
      width: 100%;
    }

    .error { color: #b91c1c; }
    .ok { color: #065f46; }
  </style>
</head>
<body>

<div class="tabs" style="margin-bottom:16px">
  <button id="tabList" class="btn active">–í—ã–±–æ—Ä –∑–≤—É–∫–∞</button>
  <button id="tabEdit" class="btn" disabled>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
</div>

<!-- ===== TAB 1: LIST ===== -->
<div id="tabListView" class="card">
  <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∑–≤—É–∫–∞..." />
  <div id="soundList"></div>
</div>

<!-- ===== TAB 2: EDIT ===== -->
<div id="tabEditView" style="display:none">
  <button id="backBtn" class="btn" style="margin-bottom:10px">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="card">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–π—Å–∞</h3>
    <div id="status" class="muted"></div>

    <audio id="editPlayer" controls></audio>

    <div class="row">
      <label>ID</label>
      <input id="id" disabled />
    </div>

    <div class="row">
      <label>Title</label>
      <input id="title" />
    </div>

    <div class="row">
      <label>Views count</label>
      <input id="views_count" type="number" min="0" />
    </div>

    <div class="row">
      <label>Category</label>
      <select id="category_id"></select>
    </div>

    <button id="applyBtn" class="btn btn-primary btn-disabled" disabled>
      –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    </button>
  </div>
</div>

<script>
let originalSound = null;

const SOUND_CATEGORIES_RU = {
  all: "–í—Å–µ",
  memes: "–ú–µ–º—ã",
  cringe: "–ö—Ä–∏–Ω–∂",
  relationships: "–û—Ç–Ω–æ—à–µ–Ω–∏—è",
  work_study: "–†–∞–±–æ—Ç–∞/–£—á—ë–±–∞",
  games: "–ò–≥—Ä—ã",
  streams: "–°—Ç—Ä–∏–º—ã",
  movies: "–§–∏–ª—å–º—ã",
  anime: "–ê–Ω–∏–º–µ",
  ambience: "–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞"
};

function getAuthToken() {
  return Telegram?.WebApp?.initData || null;
}

async function apiFetch(path, opts={}) {
  const token = getAuthToken();
  if (!token) throw new Error("–ù–µ—Ç initData");

  const res = await fetch(path, {
    method: opts.method || "GET",
    headers: {
      Authorization: token,
      "Content-Type": "application/json"
    },
    body: opts.body ? JSON.stringify(opts.body) : null
  });

  const data = await res.json();
  if (!res.ok) throw new Error(data.detail || "–û—à–∏–±–∫–∞");
  return data;
}

function setStatus(text, kind="muted") {
  status.className = kind;
  status.textContent = text;
}

/* ===== TAB 1 ===== */
async function loadSounds(search="") {
  const q = search ? `?search=${encodeURIComponent(search)}` : "";
  const data = await apiFetch(`/api/sounds${q}`);

  soundList.innerHTML = "";

  data.items.forEach(sound => {
    const div = document.createElement("div");
    div.className = "sound-item";

    div.innerHTML = `
      <strong>${sound.title}</strong><br>
      <span class="muted">üëÅ ${sound.views_count}</span>
      <audio controls src="${sound.url}"></audio>
    `;

    div.onclick = () => openEditor(sound.id);
    soundList.appendChild(div);
  });
}

/* ===== TAB 2 ===== */
async function openEditor(soundId) {
  tabListView.style.display = "none";
  tabEditView.style.display = "block";
  tabList.classList.remove("active");
  tabEdit.classList.add("active");
  tabEdit.disabled = false;

  originalSound = await apiFetch(`/api/admin/sound?sound_id=${soundId}`);

  id.value = originalSound.id;
  title.value = originalSound.title || "";
  views_count.value = originalSound.views_count || 0;

  editPlayer.src = originalSound.url;

  category_id.innerHTML = `<option value="">‚Äî</option>`;
  Object.keys(SOUND_CATEGORIES_RU).forEach(k => {
    const o = document.createElement("option");
    o.value = k;
    o.textContent = SOUND_CATEGORIES_RU[k];
    category_id.appendChild(o);
  });
  category_id.value = originalSound.category_id || "";

  applyBtn.disabled = false;
  applyBtn.classList.remove("btn-disabled");

  setStatus("–ì–æ—Ç–æ–≤–æ");
}

backBtn.onclick = () => {
  tabEditView.style.display = "none";
  tabListView.style.display = "block";
  tabEdit.classList.remove("active");
  tabList.classList.add("active");
};

applyBtn.onclick = async () => {
  try {
    setStatus("–°–æ—Ö—Ä–∞–Ω—è—é...");
    const payload = {
      ...originalSound,
      title: title.value.trim(),
      views_count: Number(views_count.value),
      category_id: category_id.value || null
    };

    await apiFetch("/api/admin/sound/change", {
      method: "POST",
      body: payload
    });

    setStatus("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã", "ok");
  } catch (e) {
    setStatus(e.message, "error");
  }
};

searchInput.oninput = e => loadSounds(e.target.value.trim());

Telegram?.WebApp?.ready?.();
Telegram?.WebApp?.expand?.();
loadSounds();
</script>

</body>
</html>
