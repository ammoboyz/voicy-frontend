<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Sound</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; max-width: 720px; }
    .row { display: grid; grid-template-columns: 160px 1fr; gap: 10px; align-items: center; margin: 10px 0; }
    label { color: #374151; font-size: 14px; }
    input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; }
    .muted { color: #6b7280; font-size: 13px; }
    .btn { width: 100%; padding: 12px 14px; border: 0; border-radius: 12px; font-size: 16px; cursor: pointer; }
    .btn-primary { background: #111827; color: white; }
    .btn-disabled { opacity: .6; cursor: not-allowed; }
    .tabs button { margin-right: 6px; padding: 8px 12px; border-radius: 10px; border: 1px solid #d1d5db; background: #f9fafb; cursor: pointer; }
    .tabs button.active { background: #111827; color: #fff; }
    .sound-item { padding: 10px; border-bottom: 1px solid #e5e7eb; cursor: pointer; }
    .sound-item:hover { background: #f9fafb; }
    pre { background: #0b1020; color: #d1d5db; padding: 12px; border-radius: 12px; overflow: auto; }
    .error { color: #b91c1c; }
    .ok { color: #065f46; }
  </style>
</head>
<body>

<div class="tabs" style="margin-bottom:16px">
  <button id="tabList" class="active">–í—ã–±–æ—Ä –∑–≤—É–∫–∞</button>
  <button id="tabEdit" disabled>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
</div>

<!-- ===== TAB 1: LIST ===== -->
<div id="tabListView" class="card">
  <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∑–≤—É–∫–∞..." />
  <div style="height:10px"></div>
  <div id="soundList"></div>
</div>

<!-- ===== TAB 2: EDIT ===== -->
<div id="tabEditView" style="display:none">
  <button id="backBtn" style="margin-bottom:10px">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="card">
    <h2 style="margin:0 0 6px 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–π—Å–∞</h2>
    <div id="status" class="muted"></div>

    <div class="row">
      <label>ID</label>
      <input id="id" disabled />
    </div>

    <div class="row">
      <label>Title</label>
      <input id="title" />
    </div>

    <div class="row">
      <label>Views count</label>
      <input id="views_count" type="number" min="0" />
    </div>

    <div class="row">
      <label>Category</label>
      <select id="category_id"></select>
    </div>

    <div class="row">
      <label>URL</label>
      <input id="url" />
    </div>

    <div style="height:14px"></div>
    <button id="applyBtn" class="btn btn-primary btn-disabled" disabled>
      –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    </button>

    <div style="height:10px"></div>
    <pre id="result" style="display:none"></pre>
  </div>
</div>

<script>
/* ================== STATE ================== */
let selectedSound = null;
let originalSound = null;

const SOUND_CATEGORIES_RU = {
  all: "–í—Å–µ",
  memes: "–ú–µ–º—ã",
  cringe: "–ö—Ä–∏–Ω–∂",
  relationships: "–û—Ç–Ω–æ—à–µ–Ω–∏—è",
  work_study: "–†–∞–±–æ—Ç–∞/–£—á—ë–±–∞",
  games: "–ò–≥—Ä—ã",
  streams: "–°—Ç—Ä–∏–º—ã",
  movies: "–§–∏–ª—å–º—ã",
  anime: "–ê–Ω–∏–º–µ",
  ambience: "–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞"
};

/* ================== HELPERS ================== */
function getAuthTokenFromTelegram() {
  return window.Telegram?.WebApp?.initData || null;
}

function setStatus(text, kind="muted") {
  const el = document.getElementById("status");
  el.className = kind === "error" ? "error" : kind === "ok" ? "ok" : "muted";
  el.textContent = text || "";
}

async function apiFetch(path, { method="GET", body=null } = {}) {
  const token = getAuthTokenFromTelegram();
  if (!token) throw new Error("–ù–µ—Ç Telegram initData");

  const headers = { Authorization: token };
  if (body) headers["Content-Type"] = "application/json";

  const res = await fetch(path, {
    method,
    headers,
    body: body ? JSON.stringify(body) : null
  });

  const text = await res.text();
  const data = text ? JSON.parse(text) : null;

  if (!res.ok) {
    throw new Error(data?.detail || data?.message || res.status);
  }
  return data;
}

/* ================== TAB 1 ================== */
async function loadSounds(search="") {
  const q = search ? `?search=${encodeURIComponent(search)}` : "";
  const data = await apiFetch(`/api/sounds${q}`);

  const list = document.getElementById("soundList");
  list.innerHTML = "";

  data.items.forEach(sound => {
    const div = document.createElement("div");
    div.className = "sound-item";
    div.innerHTML = `
      <strong>${sound.title}</strong><br>
      <span class="muted">
        üëÅ ${sound.views_count}
        ${sound.category_id ? " ‚Ä¢ " + sound.category_id : ""}
      </span>
    `;
    div.onclick = () => openEditor(sound);
    list.appendChild(div);
  });
}

/* ================== TAB 2 ================== */
async function openEditor(sound) {
  selectedSound = sound;

  document.getElementById("tabListView").style.display = "none";
  document.getElementById("tabEditView").style.display = "block";
  document.getElementById("tabList").classList.remove("active");
  document.getElementById("tabEdit").classList.add("active");
  document.getElementById("tabEdit").disabled = false;

  setStatus("–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ...");
  originalSound = await apiFetch(`/api/admin/sound?sound_id=${sound.id}`);

  document.getElementById("id").value = originalSound.id;
  document.getElementById("title").value = originalSound.title || "";
  document.getElementById("views_count").value = originalSound.views_count || 0;
  document.getElementById("url").value = originalSound.url || "";

  const sel = document.getElementById("category_id");
  sel.innerHTML = `<option value="">‚Äî</option>`;
  Object.keys(SOUND_CATEGORIES_RU).forEach(k => {
    const o = document.createElement("option");
    o.value = k;
    o.textContent = SOUND_CATEGORIES_RU[k];
    sel.appendChild(o);
  });
  sel.value = originalSound.category_id || "";

  document.getElementById("applyBtn").disabled = false;
  document.getElementById("applyBtn").classList.remove("btn-disabled");

  setStatus("–ì–æ—Ç–æ–≤–æ");
}

/* ================== EVENTS ================== */
document.getElementById("searchInput").addEventListener("input", e => {
  loadSounds(e.target.value.trim());
});

document.getElementById("backBtn").onclick = () => {
  document.getElementById("tabEditView").style.display = "none";
  document.getElementById("tabListView").style.display = "block";
  document.getElementById("tabEdit").classList.remove("active");
  document.getElementById("tabList").classList.add("active");
};

document.getElementById("applyBtn").onclick = async () => {
  try {
    setStatus("–°–æ—Ö—Ä–∞–Ω—è—é...");
    const payload = {
      ...originalSound,
      title: title.value.trim(),
      views_count: Number(views_count.value),
      category_id: category_id.value || null,
      url: url.value.trim()
    };

    const resp = await apiFetch("/api/admin/sound/change", {
      method: "POST",
      body: payload
    });

    setStatus("–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã", "ok");
    result.style.display = "block";
    result.textContent = JSON.stringify(resp, null, 2);
  } catch (e) {
    setStatus(e.message, "error");
  }
};

/* ================== INIT ================== */
Telegram?.WebApp?.ready?.();
Telegram?.WebApp?.expand?.();
loadSounds();
</script>

</body>
</html>
