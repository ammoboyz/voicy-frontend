<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Sound</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 16px;
      background: #ffffff;
      color: #111;
    }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 14px;
      max-width: 720px;
      background: #ffffff;
    }

    .tabs button {
      margin-right: 6px;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
    }

    .tabs button.active {
      font-weight: 600;
      border-bottom: 2px solid #111;
    }

    .sound-item {
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    .row {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
    }

    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
    }

    .btn {
      padding: 6px 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
    }

    .btn-primary {
      background: #111;
      color: #fff;
      border: none;
    }

    .btn-disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .muted { color: #6b7280; font-size: 13px; }
    .ok { color: #065f46; }
    .error { color: #b91c1c; }
  </style>
</head>
<body>

<div class="tabs" style="margin-bottom:16px">
  <button id="tabList" class="active">–í—ã–±–æ—Ä –∑–≤—É–∫–∞</button>
  <button id="tabEdit" disabled>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
</div>

<!-- ===== TAB 1 ===== -->
<div id="tabListView" class="card">
  <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∑–≤—É–∫–∞..." />
  <div id="soundList"></div>
  <button id="loadMoreBtn" class="btn" style="margin-top:10px; display:none">
    –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë
  </button>
</div>

<!-- ===== TAB 2 ===== -->
<div id="tabEditView" style="display:none">
  <button id="backBtn" class="btn" style="margin-bottom:10px">‚Üê –ù–∞–∑–∞–¥</button>

  <div class="card">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–π—Å–∞</h3>
    <div id="status" class="muted"></div>

    <button id="editPlayBtn" class="btn">‚ñ∂ Play</button>

    <div class="row">
      <label>ID</label>
      <input id="id" disabled />
    </div>

    <div class="row">
      <label>Title</label>
      <input id="title" />
    </div>

    <div class="row">
      <label>Views count</label>
      <input id="views_count" type="number" min="0" />
    </div>

    <div class="row">
      <label>Category</label>
      <select id="category_id"></select>
    </div>

    <button id="applyBtn" class="btn btn-primary btn-disabled" disabled>
      –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    </button>

    <div id="saveNotice" class="ok" style="display:none; margin-top:8px">
      ‚úÖ –ó–≤—É–∫ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω
    </div>
  </div>
</div>

<script>
/* ===== SIMPLE PLAYER ===== */
function createSimplePlayer(button, url) {
  let audio = null;
  let playing = false;

  button.onclick = (e) => {
    e.stopPropagation();

    if (!audio) audio = new Audio(url);

    if (playing) {
      audio.pause();
      button.textContent = "‚ñ∂ Play";
    } else {
      audio.play();
      button.textContent = "‚è∏ Pause";
    }
    playing = !playing;
  };
}

/* ===== HELPERS ===== */
function getAuthToken() {
  return Telegram?.WebApp?.initData || null;
}

async function apiFetch(path, opts = {}) {
  const token = getAuthToken();
  if (!token) throw new Error("–ù–µ—Ç initData");

  const res = await fetch(path, {
    method: opts.method || "GET",
    headers: {
      Authorization: token,
      "Content-Type": "application/json"
    },
    body: opts.body ? JSON.stringify(opts.body) : null
  });

  const data = await res.json();
  if (!res.ok) throw new Error(data.detail || "–û—à–∏–±–∫–∞");
  return data;
}

/* ===== STATE ===== */
let originalSound = null;
let page = 1;
let currentSearch = "";
let hasNext = false;

const SOUND_CATEGORIES_RU = {
  all: "–í—Å–µ",
  memes: "–ú–µ–º—ã",
  cringe: "–ö—Ä–∏–Ω–∂",
  relationships: "–û—Ç–Ω–æ—à–µ–Ω–∏—è",
  work_study: "–†–∞–±–æ—Ç–∞/–£—á—ë–±–∞",
  games: "–ò–≥—Ä—ã",
  streams: "–°—Ç—Ä–∏–º—ã",
  movies: "–§–∏–ª—å–º—ã",
  anime: "–ê–Ω–∏–º–µ",
  ambience: "–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞"
};

/* ===== TAB 1 ===== */
async function loadSounds(reset=false) {
  if (reset) {
    page = 1;
    soundList.innerHTML = "";
  }

  const params = new URLSearchParams();
  params.set("page", page);
  if (currentSearch) params.set("search", currentSearch);

  const data = await apiFetch(`/api/sounds?${params.toString()}`);

  data.items.forEach(sound => {
    const div = document.createElement("div");
    div.className = "sound-item";

    const playBtn = document.createElement("button");
    playBtn.className = "btn";
    playBtn.textContent = "‚ñ∂ Play";
    createSimplePlayer(playBtn, sound.url);

    div.innerHTML = `
      <strong>${sound.title}</strong><br>
      <span class="muted">üëÅ ${sound.views_count}</span><br>
    `;

    div.appendChild(playBtn);
    div.onclick = () => openEditor(sound.id);
    soundList.appendChild(div);
  });

  hasNext = data.has_next;
  loadMoreBtn.style.display = hasNext ? "block" : "none";
}

/* ===== TAB 2 ===== */
async function openEditor(soundId) {
  tabListView.style.display = "none";
  tabEditView.style.display = "block";
  tabList.classList.remove("active");
  tabEdit.classList.add("active");
  tabEdit.disabled = false;

  saveNotice.style.display = "none";

  originalSound = await apiFetch(`/api/admin/sound?sound_id=${soundId}`);

  id.value = originalSound.id;
  title.value = originalSound.title || "";
  views_count.value = originalSound.views_count || 0;

  createSimplePlayer(editPlayBtn, originalSound.url);

  category_id.innerHTML = `<option value="">‚Äî</option>`;
  Object.keys(SOUND_CATEGORIES_RU).forEach(k => {
    const o = document.createElement("option");
    o.value = k;
    o.textContent = SOUND_CATEGORIES_RU[k];
    category_id.appendChild(o);
  });
  category_id.value = originalSound.category_id || "";

  applyBtn.disabled = false;
  applyBtn.classList.remove("btn-disabled");
}

backBtn.onclick = () => {
  tabEditView.style.display = "none";
  tabListView.style.display = "block";
  tabEdit.classList.remove("active");
  tabList.classList.add("active");
};

/* ===== SAVE ===== */
applyBtn.onclick = async () => {
  try {
    const payload = {
      ...originalSound,
      title: title.value.trim(),
      views_count: Number(views_count.value),
      category_id: category_id.value || null
    };

    await apiFetch("/api/admin/sound/change", {
      method: "POST",
      body: payload
    });

    saveNotice.style.display = "block";

    Telegram?.WebApp?.showAlert?.("–ó–≤—É–∫ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω ‚úÖ");
  } catch (e) {
    alert(e.message);
  }
};

/* ===== EVENTS ===== */
searchInput.oninput = e => {
  currentSearch = e.target.value.trim();
  loadSounds(true);
};

loadMoreBtn.onclick = () => {
  page += 1;
  loadSounds();
};

/* ===== INIT ===== */
Telegram?.WebApp?.ready?.();
Telegram?.WebApp?.expand?.();
loadSounds(true);
</script>

</body>
</html>
